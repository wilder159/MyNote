> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [zhuanlan.zhihu.com](https://zhuanlan.zhihu.com/p/600296428)

1， 介绍
-----

本文主要介绍总线相关的知识，会从以下几个方面展开：什么是总线，为什么需要总线，总线的组成，总线的分类，ARM 中常见的总线协议是什么，然后后面的部分会着重介绍一下 ARM 中常见的总线协议及工作原理。

什么是总线呢？总线是计算机各种功能部件（运算器、控制器、内存、输入、输出等）之间传送信息的公共通信干线，它是由导线组成的传输线束。简单来说总线也是导线，是连接两个以上计算机部件的专用信号线，在各个部件之间传送信息的公共通路。

为什么需要总线呢？总的来说现代计算机及嵌入式系统基本结构，包括 3 个部件：CPU（运算器 + 控制器）、存储器、IO 设备（输入设备 + 输出设备），但在实际应用中计算机及嵌入式系统的结构远比基本结构要复杂，一个计算机或嵌入式系统中往往会有多个 CPU、存储器或者 IO 设备，这些部件只有连接在一起才能形成完整的计算机系统。这些部件可以由多种不同的拓扑结构进行连接，比如星型、树型、环形、总线型、交叉开关。这几种拓扑结构相较而言，总线型结构更有优势，它主要具有如下优点：

1）结构简单灵活，便于扩充或减少部件；

2）可靠性高，响应速度快；

3）共享资源能力强，非常便于广播式工作，即一个结点发送所有结点都可接收。

因此，计算机及嵌入式系统主要采用总线型结构连接各部件。

总线由哪些部分组成的呢？总线是从源部件传送信息到一个或多个目的部件的一组传输线，而导线则是仅仅连接一个源部件到一个或多个目的部件的传输线。总线除了要有传输导线外，重要的是总线控制线路。由于总线有输出信息的源部件，多个接收信息的目的部件，对于发送的信息就必须经过选择判优，分开发送，避免多个部件同时发送信息的矛盾。同时还应对传送的信息进行定时，防止信息丢失。这样，总线中应该设置总线控制线路。总线控制线路，包括总线判优或仲裁控制逻辑、驱动器和中断逻辑等。

都有哪些类型总线呢？其实按照不同的分类标准，总线有多种类型。按照功能分类：数据总线、地址总线、控制总线，分别用来传输数据、数据地址和控制信号。按照总线的传输格式划分：串行总线和并行总线，分别串行、并行的传输数据。按照时序控制方式划分：同步总线和异步总线，同步总线所连接的各部件使用同一个时钟，在规定的时钟节拍进行规定的总线操作，来完成部件之间的信息交换，异步总线所连接的各部件没有统一的时钟，部件之间通过信号握手的方式进行，总线操作时序不固定。我们着重关注按照总线功能划分：片内总线、系统总线、通信总线。

*   片内总线：CPU 内部的总线。它是 CPU 内部控制器、运算逻辑单元、寄存器等模块之间的公共连接线。
*   系统总线：CPU、GPU、ISP、CODEC、主存、I/O 等各大部件之间的信息传输线，它把这些部件连接起来构成了计算机或嵌入式系统。由于这些部件通常都在硬件板子上，因此又叫做板级总线和板间总线。按系统总线传输信息的不同，它又可分为三类：数据总线、地址总线和控制总线。

*   数据总线（Data Bus）：用来传输各功能部件之间的数据信息，它是双向传输总线，其位数与机器字长、存储字长有关。在任意两个涉及数据（包括要运算的数据信息，要处理的指令信息）的存储、处理乃至交换、传输的设备之间，都应有数据总线。**> 它的两个性能指标是传输的速率和总线的宽度。前者是指每个单位时间它传送多少个数据，显然这个指标将对计算机或嵌入式的运算速度有重大影响，而它与传输的距离也有关系。后者是每条总线可以同时传送多少位，也就是这个总线一共有多少条实际的物理线路，我们把它称为总线的宽度。**
*   地址总线（Address Bus）：用来指出数据总线上的源数据或目的数据所在的主存单元或 I/O 端口的地址，它是**单向传输总线**，地址总线的位数与主存地址空间的大小有关。地址总线用于传送地址信号，以确定所访问的存储单元或某个输入 / 输出端口。计算机或嵌入式中地址总线一般有 16 位、20 位、24 位、32 位、36 位等几种宽度标准，与存储器所用的地址的位数以及端口的地址位数相对应。地址总线要和数据总线一起使用才有效。比如，如果要从某个设备向存储设备存入数据，则这个数据应该放到从某个设备连接到存储设备的数据总线上，同时应在连接这两个设备的地址总线上给出存储设备的地址，这样才能实现正确的存入（写入）操作。只有掌握总线控制权的主控部件，如 CPU、DSP 等，才能向地址总线上发送地址信息。而像存储器这样不掌握总线控制权的部件，只能从地址总线上接收地址信息，并配合控制信号进行地址译码就可以了。
*   控制总线（Control Bus）：**传输的是控制信息，包括 CPU 送出的控制命令和主存（或外设）返回 CPU 的状态反馈信号。**其实要实现对存储器的读、写操作，需要在控制信号上的信号控制之下，同时有数据总线、地址总线的参与，读、写操作才能实现。以实现把数据总线上的数据存入地址总线给出相应地址的存储器的某个存储单元为例，控制总线在其工作的周期中首先使地址总线工作，从而使相应单元发送地址信息到存储器做好接收数据的准备，然后使数据总线工作，把它上面的数据写到该存储单元中。地址总线与数据总线上的信息一直维持到控制总线工作周期的结束。

*   通信总线：用于计算机或嵌入式系统之间或计算机或嵌入式系统与其他系统（如远程通信设备、测试设备）之间信息传送的总线，通信总线也称为外部总线。常见的通信总线，比如 USB、PCIE、SPI、IIC、UART 等总线。

ARM 为高性能嵌入式系统定义了 AMBA(Advanced Micro-Controller Bus Architecture，高级微控制器总线架构)On-Chip Bus 片上总线规范，这个协议定义的主要是一系列系统总线。比如，AHB（Advanced High-Performance Bus，高级高性能总线）、APB（Advanced Peripheral Bus，高级外设总线）、AXI（Advanced Extensible Interface，高级可扩展接口总线）、ACE（AXI Coherency Extensions，AXI 一致扩展总线）、ASB（Advanced System Bus，高级系统总线）等。接下来重点介绍一下 AHB、APB、AXI 总线。

AHB（用于高性能，高数据吞吐部件，如 CPU、DMA、DSP 之间的连接）、APB（为系统的低速外部设备提供低功耗的简易互连）、AXI（主要面向高性能地址映射通信的需求）

2，AMBA 总线
---------

### 2.1 AMBA 的演进

AMBA 是 ARM 在 1996 年推出的互联协议，主要用在片上系统中各 IP（比如：CPU、GPU、内存、DSP 等）之间的通信，整个通信基于主从协议。AMBA 促进了 IP 的模块化设计、可重用性、兼容性和可扩展性。

AMBA 高级微控制器总线架构的演进过程如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/49cb50417f824851be71575fff60dfb9_MD5.jpg]]

AMBA 自 1996 年以来经过不断发展，目前已经发展到第五代了。APB（高级外设总线）和 ASB（高级系统总线）是最早的 AMBA 总线协议。随后在 1999 年推出了 AMBA2，在此版本中，AMBA 增加了 AHB（高性能总线）。到 2003 年，AMBA3 引入了 AXI（高级可扩展接口），将互连的性能做了比较大的提升。它还带来了 ATB（高级跟踪总线），用于 CoreSight 跟踪的解决方案和片上调试。ASB 总线协议由于设计复杂而不再使用。这种设计持续了多年，直到 2010 年 AMBA4 引入了 ACE（AXI 一致性扩展总线）。引入 QoS 和 long burst 的支持，根据不同应用可选择 AXI4、AXI4-lite、AXI4-stream。这个版本在很大程度上提升了 AXI，并为新版本奠定了基础。到 2013 年，AMBA5 出现了，并提供了 CHI（相干集线器接口）以及新设计的高速传输应用程序，有助于减少拥堵。AMBA 的影响如此之大，以至于今天这些协议被作为所有嵌入式处理器的行业标准。

APB：**是低带宽总线协议，为了支持外围设备，在低功耗和低复杂性方面进行了特定的优化。读写操作共享同一组信号，不支持 burst 数据传输**。它用作外围设备的低成本接口，不需要大量数据，低延时的传输，因此不需要高性能的流水线总线接口。**APB 总线的任何传输至少需要 2 个周期。**典型的含有 APB 总线的系统，在 AHB、AXI 与连接外围设备接口的 APB 总线之间含有 APB 桥接器，通过它可以访问外围设备的可编程寄存器。

AHB：主要是针对高性能、高时钟频率及快速系统模块所设计的总线，它充当高性能系统主干总线，可以连接如微处理器、芯片上或芯片外的内存模块和 DMA 等高效率模块。它支持多个总线主控并支持高带宽操作。典型的 AMBA 系统设计包含 AHB 主机、AHB 从机、AHB 仲裁器和 AHB 解码器。它用于在共享总线上连接需要高带宽的组件，如 DMA、DSP 和内存。AMBA AHB 支持了如下特性：

*   突发传输
*   拆分交易
*   更宽的数据总线配置（64/128 位）
*   单时钟边沿操作
*   单周期总线主切换

AHB-lite：是 AHB 的一个简化版本。简化后只支持一个 Master，这消除了对任何仲裁、重试、分割事务等的需求，通过简化设计，提高了传输性能。

AXI：是一种并行、高性能、高频率、同步的总线协议。适合于高带宽和低延迟互连。这是一个点对点的互连协议，支持乱序传输、读写通道分离，它克服了 AHB、APB 等**共享总线协议在可连接的代理数量方面的限制。该协议支持多个 outstanding 的数据传输（多组未完成事务共存）、burst 数据**传输、单独的读写通道和支持不同的总线宽度。它针对高性能和高频系统，具有以下主要特点：

*   多笔未完成交易
*   乱序数据补全
*   仅发布起始地址的基于突发的事务
*   支持使用选通的非对齐数据传输
*   同时读取和写入事务
*   用于高速操作的流水线互连

AXI-lite：简单低吞吐量的内存映射通信，是 AXI 总线协议的简化版本，简化后不支持突发数据传输，用于操作控制和状态寄存器。

AXI-stream：是 AXI 总线协议的另一种风格，它只支持数据流从 master 流到 slave 单向流动，用于高速流数据传输。与完整的 AXI 或 AXI-lite 不同，AXI-stream 协议数据流只在一个方向流动，没有单独的读、写通道。

ACE：AXI4 协议的扩展，应用于在一个芯片上集成多个 CPU 核心与一致性 cache 的场景。ACE 协议扩展了 AXI 读写数据通道，同时引入了单独的 snoop 地址、snoop 数据和 snoop 响应通道。这些额外的通道提供了实现基于 snoop 的一致性协议的机制。ACE 一致性协议确保所有 master 都能看到任何地址位置的正确数据。这避免了对缓存之间主要一致性的软件缓存维护。ACE 还提供屏障事务来保证系统内多个事务的排序，以及分布式虚拟内存 (DVM) 功能来管理虚拟内存。

ACE-Lite：对于没有自己 cache 的 agents，但仍属于可共享一致性域的一部分，如 DMA 或网络接口 agent，使用 ACE-lite 协议实现这种 “单向” 一致性。

CHI：ACE 协议作为 AXI 的扩展而开发，以支持一致性互连。ACE 协议使用了 master/slave 之间的信号电平通信，因此互连需要大量的线和增加的通道来进行 snoops 和响应。随着 SOC 上集成越来越多的一致性 clusters，AMBA5 修订版引入了 CHI 协议。定义了连接完全一致的处理器的接口。它是一种基于数据包的分层通信协议，具有协议、链路和网络层。它与拓扑无关，并提供基于服务质量 (QoS) 的机制来控制系统中的资源。它支持处理器之间的高频和非阻塞相干数据传输，为数据中心等应用提供性能和规模。

以上的 AMBA 演进及各总线协议的介绍，是我们深入地了解这些协议的开始，要想进一步深入了解这些总线的最好方法是阅读相应的协议规范，通过这些协议规范，我们可以了解每个协议的细节。其中 APB 和 AHB 总线协议相对简单，比较容易学习。而 AXI 和 ACE、CHI 总线相对复杂，需要详细阅读，以及了解缓存一致性和一般通信协议的基本知识，加上实践才能掌握这些总线协议。本文后面会详细介绍 APB、AHB 及 AXI，由于是现学现卖，难免会有理解不到位的地方，仅供大家参考。

### 2.2 AMBA 总线框架

2.2.1 AMBA 总线系统框图

![[../../_resources/一文搞懂 AMBA 总线工作原理/a6522dfcab86fa59cbf24515678f3556_MD5.jpg]]

系统总线连接的设备，根据功能不同分为主模块和从模块。大部分挂在总线上的模块只是单一属性的功能模块：比如要么是主模块，要么是从模块。主模块是向从模块发出读写操作的模块，如 CPU、DSP 等。从模块是接受主模块发来的命令并做出反应的模块，如片上的 RAM，AHB／APB 桥接器等。另外，还有一些模块同时具有两种属性，比如 DMA（直接存储器存取），在被 CPU 编程时是从模块，但在后续传输数据时是主模块。

系统芯片上，通常设计多个主模块和多个从模块。不同的从模块在总线上对应着互不重叠的地址区**间，总线通过主模块发起传输任务的目标地址。AXI 总线使用不同的 ID 号来区分主模块，主模块可以在其他主模块访问未完成的情况下继续发起请求。同一条 AHB 总线上的设备共享固定的地址数据传输通道，这意味着其中一个主模块占**用 AHB 总线后，其余主模块均处于等待状态。如果总线上存在多个主模块，这就需要仲裁器来决定如何控制各种主模块对总线的访问。虽然仲裁规范是 AMBA 总线规范中的一部分，但具体使用的算法由 RTL 设计工程师决定，其中两个最常用的算法是固定优先级算法和循环制算法。AHB 总线上最多可以有 16 个主模块和任意多个从模块，如果主模块数目大于 16，则需再加一层结构 (具体参阅 ARM 公司推出的 Multi-layer AHB 规范)。

AHB-APB 桥接器既是 APB 总线上唯一的主模块，也是 AHB 总线上的从模块。其主要功能是锁存来自 AHB 系统总线的地址、数据和控制信号，并提供二级译码以产生 APB 外围设备的选择信号，从而实现 AHB 协议到 APB 协议的转换。AXI-AHB 桥接器跟 AHB-APB 桥接器具有类似的功能。

如上 AMBA 系统总线框图，AXI 总线连接嵌入式处理器、片内 RAM、DMA 主机、ISP、CODEC 等高速设备，AHB 总线连接着 PCIE、USB、HDMI、ROM 等高速接口设备，APB 总线连接 UART、SPI、IIC、GPIO、TIMER 等低速设备。这样处理器就能通过这些总线及桥接器访问到相应的从模块。根据工作频率不同，总线被设计成高速总线和低速总线：高速总线支持较高的时钟频率，拥有较高的数据带宽和性能，但功耗也比较高，一般适用于处理器、DSP、DMA 等高速设备的连接。低速总线工作频率低，虽然性能差，但功耗也低，适合挂载串口等低速外设。

2.2.2 总线术语

*   Transfer 与 transaction：transfer 指的是传输 1bit 数据，transaction 是多个 transfer 的集合（在 AXI 里也成为一个 burst）。Transaction 是包含整个 burst 的传输，包括 address/data/response。Transfer 值的是单个信息的传输，比如一个 address 或一个 data。
*   Burst 传输：在 AXI 协议中，一个 transaction 一般以一个 burst 为单位进行传输，burst 的传输类型：FIXED、INCR、WRAP。
*   Outstanding 传输：表示正在进行中的传输，master 在当前 transaction 任务完成之前，就可以开始进行下一个 transaction，因此系统中可能存在多个 outstanding 的 transaction。即一个 transaction 已经发出，但还没有得到 response。

2.2.3 总线的性能指标

*   总线时钟周期：机器的时钟周期。计算机有一个统一的时钟，以控制整个计算机的各个部件，总线也要受此时钟的控制。大多数情况下，一个总线周期包含多个总线时钟周期。有时，一个总线周期就是一个总线时钟周期。有时，一个总线时钟周期可包含多个总线周期。
*   总线的时钟频率：即机器的时钟频率，为总线时钟周期的倒数。若总线时钟周期为 T，则总线时钟频率为 1/T。实际上指一秒内有多少个时钟周期。
*   总线的传输周期 (总线周期)：一次总线操作所需的时间（包括申请阶段、寻址阶段、传输阶段和结束阶段），通常由若干个总线时钟周期构成。
*   总线的工作频率：总线上各种操作的频率，为总线周期的倒数。若总线周期 = N 个总线时钟周期，则总线的工作频率 = 时钟频率 / N。实际上指一秒内传送几次数据。
*   总线宽度：又称为总线位宽，它是总线上同时能够传输的数据位数，通常是指数据总线的根数，如 32 根称为 32 位（bit）总线。
*   总线带宽：可理解为总线的数据传输率，即单位时间内总线上可传输数据的位数，通常用每秒钟传送信息的字节数来衡量，单位可用字节 / 秒（B/s）表示。总线带宽 = 总线工作频率 × 总线宽度 (bit/s)= 总线工作频率 ×(总线宽度 / 8)(B/s)=（总线宽度）/（总线周期）(bit/s)。总线带宽是指总线本身所能达到的最高传输速率。在计算实际的有效数据传输率时，要用实际传输的数据量除以耗时。
*   总线复用：总线复用是指一种信号线在不同的时间传输不同的信息。可以使用较少的线传输更多的信息，从而节省了空间和成本。
*   信号线数：地址总线、数据总线和控制总线 3 种总线数的总和称为信号线数。

2.2.4 总线仲裁

由于总线上连接着许多模块（设备），什么时候由哪个模块发送信息，如何给信息传送定时，如何防止信息丢失，如何避免多个模块同时发送，如何规定接受信息的模块等等一系列问题，都需要由总线控制器进行管理。它主要包括总线仲裁（或称为总线判优控制）和通信控制两个方面。

总线上所连接的各类设备，按其对总线有无控制功能可分为主设备和从设备两种。主设备对总线有控制权，从设备只能响应从主设备发来的总线命令。总线上信息的传送是由主设备启动的。

如某个主设备想与另一个设备进行通信时，首先由主设备发出总线请求信号，若多个主设备同时要使用总线时，就由总线控制器的判优、仲裁逻辑按一定的优先等级顺序，确定哪个主设备能先使用总线。只有获得总线使用权的主设备才能开始传送数据。

总线仲裁方式可分集中式和分布式两种，前者有一个称为总线控制器或仲裁器的硬件设备负责分配总线使用权，这个设备可以是独立的模块，也可以是 CPU 的一部分。后者没有明确的总线控制器，而是将控制逻辑功能分散在与总线连接的各个部件或设备中。

常见的仲裁管理方式如下：

1）链式查询方式（集中式）

为减少总线授权线数量，采用下图所示的菊花链查询方式（BS 总线忙、BR 总线请求、BG 总线同意）。

![[../../_resources/一文搞懂 AMBA 总线工作原理/dedaced1de24d2707757e5d3ec087685_MD5.jpg]]

链式查询方式的主要特点是：总线授权信号 BG 串行地从一个 I/O 接口传送到下一个 I/O 接口，假如 BG 到达的接口无总线请求，则继续往下查询，假如 BG 到达的接口有总线请求，BG 信号便不再往下查询，发出相应的 BR 信号，并置 BS 信号。这意味着该 I/O 接口就获得了总线控制权。

可见，在查询链中离中央仲裁器最近的设备具有最高优先级，离中央仲裁器越远，优先级越低。因此，链式查询是通过接口的优先级排队电路来实现的。链式查询方式存在的优缺点如下：

*   优点：只用很少几根线就能按一定优先级实现总线仲裁，并且这种链式结构很容易扩充设备。
*   缺点：对询问链的电路故障很敏感，如果第 n 个设备的接口中有关的电路有故障，那么第 n 个以后的设备都不能进行工作。另外查询链的优先级是固定的，如果优先级高的设备频繁出现请求时，那么优先级较低的设备可能长期不能使用总线。

2）计数器定时查询方式（集中式）

与链式查询方式相比，多了一组设备地址线，少了一根总线同意线 BG。总线控制模块接到由 BR 送来的总线请求信号后，在总线未被使用（BS=0）的情况下，由计数器开始计数，按计数值向各设备发出一组地址信号。当某个有总线请求的设备地址与计数值一致时，便获得总线使用权，此时终止计数查询。

![[../../_resources/一文搞懂 AMBA 总线工作原理/62b83c6dcf80e75ffe3f86b1ca5d843a_MD5.jpg]]

这种方式的特点是：计数可以从 “0” 开始，此时设备的优先次序是固定的；计数也可以从中止点开始，既是一种循环方法，此时设备使用总线的优先级相等。计数器的初始值还可由程序设置，故优先次序可以改变。此外对电路故障不如链式查询方式敏感，但增加了主控制线数，控制也较复杂。

3）独立请求方式（集中式）

独立请求方式如下图所示。其中每一个共享总线的设备均有一对总线请求线 BRi 和总线授权线 BGi。当设备要求使用总线时，便发出该设备的请求信号 BRi。总线控制部件中有一排队电路，可根据优先次序确定响应哪一设备的请求，给设备发相应的授权信号 BGi。独立请求方式的优点是响应时间快，优先级次序控制灵活。但其缺点是控制线数量多。

![[../../_resources/一文搞懂 AMBA 总线工作原理/f6686d7eda9fc04fe76dd0d71c4221ef_MD5.jpg]]

4）分布仲裁方式（分布式）

分布式仲裁不需要中央仲裁器，每个潜在的主控功能模块都有自己的仲裁号和仲裁器。当它们有总线请求时，把它们惟一的仲裁号发送到共享的仲裁总线上，每个仲裁器将仲裁总线上得到的号与自己的号进行比较。如果仲裁总线上的号大，则就撤销自己向仲裁总线发送的仲裁号。最后，获胜者的仲裁号保留在仲裁总线上，获得总线控制权。

2.2.5 总线操作和定时

操作和定时主要解决占用总线的一对设备（主模块和从模块）如何进行数据传输的问题。总线定时是指总线在双方交换数据的过程中需要时间上配合关系的控制，这种控制称为总线定时，它的实质是一种协议或规则。

1）总线传输的四个阶段

*   申请分配阶段：由需要使用总线的主模块（或主设备）提出申请，经总线仲裁模块决定将下一传输周期的总线使用权授予某一个申请者。也可将此阶段细分为传输请求和总线仲裁两个阶段。
*   寻址阶段：获得使用权的主模块通过总线发出本次要访问的从模块的地址及有关命令，启动参与本次传输的从模块。
*   传输阶段：主模块和从模块进行数据交换，可单向或双向进行数据传送。
*   结束阶段：主模块的有关信息均从系统总线上撤除，让出总线使用权。

2）总线的定时

总线的定时主要分为两种，同步定时和异步定时。

同步定时方式是指系统采用一个统一的时钟信号来协调发送和接收双方的传送定时关系。若干个时钟产生相等的时间间隔，每个间隔构成一个总线周期。在一个总线周期中，发送方和接收方可进行一次数据传送。因为采用统一的时钟，每个模块或设备发送或接收信息都在固定的总线传送周期中，一个总线的传送周期结束，下一个总线传送周期开始。同步通信适用于总线长度较短及总线所接模块的存取时间比较接近的系统。

*   优点：传送速度快，具有较高的传输速率，总线控制逻辑简单。
*   缺点：主从模块属于强制性同步，不能及时进行数据通信的有效性检验，可靠性较差。

在异步定时方式中，没有统一的时钟，也没有固定的时间间隔，完全依靠传送双方相互制约的 “握手” 信号来实现定时控制。主模块提出交换信息的 “请求” 信号，经接口传送到从模块。从模块接到主模块的请求后，通过接口向主模块发出 “回答” 信号。

*   优点：总线周期长度可变，能保证两个工作速度相差很大的部件或设备之间可靠地进行信息交换，自动适应时间的配合。
*   缺点：比同步控制方式稍复杂一些，速度比同步定时方式慢。

根据 “请求” 和“回答”信号的撤销是否互锁，分为以下 3 种类型。不互锁方式速度最快，可靠性最差，全互锁方式最可靠，速度最慢。

*   不互锁方式：主模块发出 “请求” 信号后，不必等到接到从模块的 “回答” 信号，而是经过一段时间，便撤销 “请求” 信号。而从模块在接到 “请求” 信号后，发出 “回答” 信号，并经过一段时间，自动撤销 “回答” 信号。双方不存在互锁关系。
*   半互锁方式：主模块发出 “请求” 信号后，必须等接到从模块的 “回答” 信号后，才撤销 “请求” 信号，有互锁的关系。而从模块在接到 “请求” 信号后，发出 “回答” 信号，但不必等待获知主模块的 “请求” 信号已经撤销，而是隔一段时间后自动撤销 “回答” 信号，不存在互锁关系。
*   全互锁方式：主模块发出 “请求” 信号后，必须等从模块 “回答” 后，才撤销 “请求” 信号。从模块发出 “回答” 信号，必须待获知主模块 “请求” 信号已撤销后，再撤销其 “回答” 信号。双方存在互锁关系。

### 2.3 APB 总线

2.3.1 APB 总线简介

APB 总线属于 AMBA 总线协议系列之一，它用在低带宽、低性能、低功耗的外围设备上，**它属于非流水线结构，**所有的信号仅在时钟上升沿时产生变化，这就规范了 APB 外围设备的设计流程，增加了可扩展性，**每个传输至少需要两个时钟周期。**另外，**APB 无需等待周期和回应信号，只有四个控制信号，控制逻辑简单。**

APB 经过了几个版本的演进越来越完善，每个版本的差异如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/e9c789cdc02a3fe7930766126a89b82a_MD5.png]]

2.3.2 APB 传输状态图

![[../../_resources/一文搞懂 AMBA 总线工作原理/3b179b1e71c592174b7daf32c050d963_MD5.jpg]]

状态介绍：

*   IDLE：APB 总线上没有数据传输时的空闲状态，也是 APB 的 default 状态。
*   SETUP：当一个 transfer 被请求后，APB 总线就会切换到该状态。
*   ACCESS：SETUP 只会保持一个时钟，在下一个时钟上升沿会切换到该状态。

状态切换过程：

*   APB 总线初始化为 IDLE 状态，这时没有传输操作，也没有选中 slave 模块。
*   当有 transfer 需要进行时，PSELx=1，PENABLE=0，APB 总线进入 SETUP 状态，并在 SETUP 状态下停留一个时钟周期。当下一个 PCLK 时钟上升沿到来时，APB 总线进入 ACCESS 状态。
*   APB 总线进入 ACCESS 状态时，维持之前在 SETUP 状态的 PADDR、PSEL、PWRITE，然后将 PENABLE 置为 1。传输也只会在 ACCESS 状态维持一个周期，在经过 SETUP 与 ACCESS 状态之后，传输也已经完成了。
*   之后如果没有新的 transfer 需要进行，就进入 IDLE 状态等待，如果有连续的传输，则进入 SETUP 状态。

2.3.3 APB 信号

![[../../_resources/一文搞懂 AMBA 总线工作原理/526c7b1703d017cb3784bed96fff3e5b_MD5.jpg]]

2.3.4 APB 写传输

**写传输包括两种类型：无等待状态和有等待状态。**

1）无等待状态的写传输

![[../../_resources/一文搞懂 AMBA 总线工作原理/69886f3aa227d91f254ebf78a4ce7648_MD5.jpg]]

地址、写入信号、写入数据和选择信号都在时钟上升沿时改变。在 T1 时刻，把要访问的地址、命令和数据全部放到 APB 总线上，开始一个写传输，在时钟的上升沿会写地址 PADDR、写数据 PWDATA、使能写信号 PWRITE，然后使能选择 PSEL 信号，选择从设备。这个时钟周期对应的阶段叫做 SETUP。在 T2 时刻，在 PCLK 的上升沿，使能 PENABLE 以及 PREADY 信号，从设备发现自己的 PSEL 信号为高，就知道主设备选择它来处理数据的写操作，此时从设备内部准备号处理数据的准备动作。PENABLE 的使能代表着 ACCESS 传输阶段的开始。在下一个 PCLK 的上升沿，PREADY 信号的改变表明从设备完成了这笔传输。在 T3 传输结束时刻到来前，PADDR、写数据 PWDATA 和控制信号保持有效，直到 T3 时刻 PCLK 的上升沿到来才会结束 ACCESS 阶段，从设备完成总线上数据采样并进行内部数据处理。在传输结束的时候，如果没有其他的相同的外设传输发起，PENABLE 和 PSEL 信号会被清除。

2）有等待状态的写传输

![[../../_resources/一文搞懂 AMBA 总线工作原理/2d4ebd3f61233e5896184028bccb3bba_MD5.jpg]]

如上时序图，展示了从设备怎么使用 PREADY 信号扩展传输。在 ACCESS 阶段，当 PENABLE 被置位，从设备通过拉低 PREADY 来扩展传输。在 PREADY 保持低电平时，如下信号保持不变，比如：PADDR、PWRITE、PSEL、PENABLE、PWDATA、PSTRB、PPORT。当 PENABLE 被置低，PREADY 状态不确定，这确保具有两个固定时钟周期访问的外设能保持 PREADY 高。建议地址和写信号在传输结束后，保持稳定不做快速变化，直到另外一个访问产生。这会减少不必要的功耗消耗。

2.3.5 APB 读传输

**读传输也包括两种类型：无等待状态和有等待传输。**

1）无等待状态的读传输

![[../../_resources/一文搞懂 AMBA 总线工作原理/8099a346f53b902c07f856b491495de2_MD5.jpg]]

如上时序图，展示了一个读传输。主设备在 T1 时刻把所要访问的地址，命令全部放到 APB 总线上，沿着组成 APB 的接口传播到从设备接口处。在 T2 时刻，从机发现自己的 PSEL 信号为高，就知道主机需要它内部的数据（PWRITE ==0），此时从机内部准备好返回数据，并把返回的数据放在数据总线上，在 T3 时刻，主机完成总线上数据采样得到需要的数据。

2）有等待状态的读传输

![[../../_resources/一文搞懂 AMBA 总线工作原理/b3b5fc045a00aeddafe2ffea9a08e0c0_MD5.jpg]]

上时序图显示了信号是如何扩展传输的。如果在 Access phase 期间 PREADY 信号拉低，则传输被扩展。但下述信号不变：

*   地址：PADDR
*   写信号：PWRITE
*   选择信号：PSEL
*   使能信号：PENABLE.

图中显示了如何使用 PREADY 信号来添加两个周期，也可以添加数个周期。

2.3.6 APB 错误响应

使用 PSLVERR 来表明 APB 传输的错误状态。在读或者写传输的时候都有可能产生错误状态。使用 PSLVERR 来指示 APB 传输错误。当 PSEL、PENABLE 以及 PREADY 都为高时，PSLVERR 才在最后一个周期进行判断。当任何一个 PSEL、 PENABLE 或者 PREADY 为低时，你可以将 PSLVERR 拉低，这是推荐，并不是强制要求。收到一个错误后，可能或不可能改变外围器件的状态。这是外设的特性，两者都是可以接受。当一个写传输收到一个错误，这并不是说外设的寄存器没有被主设备更新。当收到一个读传输的错误，这意味着返回的是无效的数据。没必要在读传输失败的时候，通过总线返回 0。APB 外围设备不要求必须支持 PSLVERR 引脚，当不使用该引脚时，应被置低。

1）写传输失败

![[../../_resources/一文搞懂 AMBA 总线工作原理/c0399ffe0e056b88d433b49ec40113d7_MD5.jpg]]

上图显示了一个写传输失败的时序图。在 PSEL、PENABLE 以及 PREADY 都为高时，PSLVERR 在最后一个周期进行判断，上图显示 PSLVERR 返回了一个错误。

2）读传输失败

![[../../_resources/一文搞懂 AMBA 总线工作原理/376de93eece54aa1b40676d95aefb57f_MD5.jpg]]

一个读传输可能是以总线返回错误结束，这表明当前这笔读传输返回的数据是无效的。上图显示了一个读传输失败的时序图。

### 2.4 AHB 总线

2.4.1 AHB 总线简介

![[../../_resources/一文搞懂 AMBA 总线工作原理/f13a6fcc37c349eb7226fa5bcc8a86ac_MD5.jpg]]

**AHB 是一种高性能、高时钟频率的 AMBA 总线协议。主要用于连接 RAM、DMA、Bridge 等高速设备。**主要支持如下特性：**burst 传输、Split 事务处理、单周期 master 移交、流水线操作、支持多个总线主设备。**

AHB 总线的强大之处在于它可以将微控制器 CPU、高带宽的片上 RAM、高带宽的外部存储器接口、DMA 总线 master、各种拥有 AHB 接口的控制器等连接起来，构成一个独立的完成 SOC 系统。不仅如此，还可以通过 AHB-APB 桥来连接 APB 总线系统。AHB 可以成为一个完成的 SOC 芯片的骨架

2.4.2 AHB 的组成

![[../../_resources/一文搞懂 AMBA 总线工作原理/9f9786d01f6a6a55402e2f8f541eb01b_MD5.jpg]]

完整的 AHB 总线由四个部分构成：

*   AHB 主设备 Master：总线主设备能够通过提供地址和信息发起读写操作，任何时候，只允许一个总线主设备处于有效状态，并使用总线。
*   AHB 从设备 Slave：从设备在给定的地址空间范围内响应读写操作，总线从设备将成功、失败或者等待数据传输的信号返回给有效的主设备。
*   AHB 仲裁器 Arbiter：**总线仲裁器确保每次只有一个总线主机被允许发起数据传输。**即使仲裁协议已经固定，任何一种仲裁算法，比如最高优先级或者公平访问都能根据应用要求而得到执行。AHB 必须只包含一个仲裁器，尽管在单总线主设备系统中这显得并不重要。
*   AHB 译码器 Decoder：AHB 译码器用来对每次传输进行地址译码，并且在传输中包含一个从设备选择信号。

每个 AHB 都需要一个仲裁器和一个解码器，并且分别有且只有一个。

总线可分为三组：

*   写数据总线（HWDATA）
*   读数据总线（HRDATA）
*   地址控制总线（HADDR）

2.4.3 AHB 总线操作

主设备通过驱动地址和控制信号开始一次传输。这些信号提供了地址、方向、传输的位宽，如果传输的类型是猝发，那么会指示出传输的类型。传输的类型可以是：

*   单次传输（Single）。
*   递增猝发（Incrementing burst），即在地址边界处不进行包装（地址不进行回绕）。
*   包装猝发（Warpping burst），及到达地址边界处重新包装下一次传输的地址（地址回绕）。

写操作数据由主设备到从设备，读数据数据由从设备到主设备。每次传输都包含两个阶段：

*   地址阶段（Address phase），地址和控制周期。
*   数据阶段（Data phase），数据周期是一个或多个周期。

从设备不能请求 Address phase 进行延长，所以所有的从设备必须具备在 Address phase 周期采样地址的能力。但是从设备可以请求主设备延长 Data phase，通过控制 HREADY。HREADY 信号为低时，从设备可以在传输中插入等待状态，使得从设备具有额外的时间提供和采样数据。最后从设备使用 HRESP 表明传输的成功 / 失败。

2.4.4 AHB 信号

![[../../_resources/一文搞懂 AMBA 总线工作原理/1bbdfa425aa74c266ddf55ca48f8d6eb_MD5.jpg]]

从上面的表可以看出，为了克服 APB 的缺点，从而支持多主机模式。提升效率操作，在总线接口数量上做了增加，并且位宽也做了提升。

2.4.5 AHB 传输

1）AHB 传输过程

AHB 传输分为以下几个部分：

*   主模块获取总线使用权：主模块向仲裁器发送总线请求信号，仲裁器发送应答后主模块可以开始传输。
*   数据传输：主模块向从模块传输数据，分为如下两个部分：

*   发送地址和控制信号：包括地址、位宽、突发类型（增量突发和回卷突发）等控制新高，仅一个时钟周期。
*   数据传输：进行数据交换，一个或多个时钟周期。

*   从模块应答：从模块通过 HRESP 和 HREADY 标记完成状态，对于 HRESP，有以下状态：

*   OKAY：标记传输完成，当 HRESP 为该状态且 HREADY 拉高时，传输完成。
*   ERROR：标记传输出错
*   RETRY 和 SPLIT：标记传输未完成，主模块仍需要占用总线。

前面已介绍一个基本的传输包括两个阶段：

*   地址：持续一个系统时钟 HCLK 周期，除非被上一个传输延长
*   数据：可能需要数个系统时钟 HCLK 周期，使用 HREADY 信号来控制完成一次传输所需要的时钟周期。

HWRITE：控制数据的方向。当为高时，表明进行一次写传输，数据有主模块端发送，从模块端接收。当为低时，表明进行一次读传输，从模块端产生读数据，主模块端接收读数据。

2）无等待状态传输

![[../../_resources/一文搞懂 AMBA 总线工作原理/a8e8e12d457c2a3edaceef9fe0bb213f_MD5.jpg]]![[../../_resources/一文搞懂 AMBA 总线工作原理/567d2226611aa79514f20d370787e0ee_MD5.jpg]]

上图是没有等待状态的简单传输的时序图，所以此传输包含一个地址周期和一个数据周期。3.1 为读传输，3.2 为写传输。在这个没有等待状态的传输中：

*   主模块端在第一个时钟 HCLK 上升沿将地址和控制信号到总线。
*   从模块端在接下来的一个时钟 HCLK 上升沿进行地址和控制信号采样。
*   在从模块端对地址和控制信号采样结束后，从模块端可以驱动 HEADYOUT 信号及数据作为回应。该信号及数据由主模块端在传输的第三个时钟 HCLK 上升沿进行采样。

这个例子说明了地址和数据阶段在不同的时钟周期是如何传输的。任意一次传输的地址阶段发生在上一次传输的数据阶段（重合，即当前传输的地址阶段和前一次传输的数据阶段重合）。address 与 data 的重合是进行总线流水线处理的基础，此特性允许总线高性能操作，同时也为从模块端发送反馈信息提供了充足的时间。

2）有等待状态传输

从模块端可以插入等待阶段到任意一个传输中从而延长完成传输的时间。每个从模块端具有一个 HREADYOUT 信号，该信号为从模块端在 data phase 阶段驱动。互联结构需要将每个从模块端的 HREADYOUT 信号联合起来产生一个 HREADY 信号，HREADY 信号用来控制上述延长传输完成时间的过程。

![[../../_resources/一文搞懂 AMBA 总线工作原理/1f37700132ca16f135ce148b68f26954_MD5.jpg]]![[../../_resources/一文搞懂 AMBA 总线工作原理/e8cb0eda376842ce0546b2b168d15217_MD5.jpg]]

如上图是具有等待阶段的时序图。3.3 是带有两个等待周期的读传输，3.4 是带有一个等待周期的写传输。有等待传输下，数据传输阶段可以扩展，即在 HREADY 拉高之前，数据传输阶段不结束。要求写数据在 HREADY 拉高前保持稳定，主模块在 HRAEADY 拉高后采样读数据。对于写操作，在 HREADY 为低的等待阶段内，主模块端需要将写数据 DATA 保持不变，直到写操作完成。对于读操作，从模块端只需要在 HREADY 为高的周期内提供有效数据即可。

当传输由具有等待阶段通过延长 address 阶段进行延长时，那么对接下来的传输具有副作用。3.5 是包含地址不相关的 3 次传输，A，B 和带有一个等待周期的 C 传输。

![[../../_resources/一文搞懂 AMBA 总线工作原理/01bee40bd61ef0ac46a43635415e7cca_MD5.jpg]]

在上述时序图中：

*   传输 A 和传输 C 是 0 等待传输。
*   传输 B 具有一个等待周期的 address phase。
*   延长传输 B 的数据 phase 对下一次传输 C 的 address phase 会相应的拉长。

2.4.6 传输类型

1）传输类型

传输类型使用端口 HTRANS 标记，有以下取值：

*   IDLE（0b00）：标志主模块占有 AHB 总线，但是没有数据传输发生。从模块需要使用 OKAY 状态回应该类型
*   BUSY（0b 01）：标志主模块占有 AHB 总线并在进行突发传输，但下一个传输不能立刻发生。从模块需要使用 OKAY 状态回应
*   NONSEQ（0b 10）：标志主模块当前发送的地址和控制信号与上一次传输无关（单次传输就是该状态）
*   SEQ（0b 11）：标记主模块处于突发传输的中间部分，即当前发送的地址和控制信号与上一次地址和控制信号有关

2）突发类型

突发传输分为两类：

*   增量突发：传输过程中传输地址递增。下一次传输的地址是上一次地址加上一个增量。
*   回卷突发：猝发的地址范围被限制在一个固定范围之内，传输地址递增，若是超出则回到地址范围的开始的地址。例如从 0x34 进行增量为 4，范围为 16 的回卷突发，地址顺序为 0x34、0x38、0x3c，0x30

突发类型使用字段 HBURST 标记，含义如下表所示：

![[../../_resources/一文搞懂 AMBA 总线工作原理/4653553da23311f251aa43ddf83900a2_MD5.jpg]]

注意一次突发传输不能跨越 1kB 的地址区间，且传输的起始地址必须与数据类型对应，例如传输字数据的二进制起始地址必须满足后两位为 00。

3）突发终止

从机通过监控 HTRANS 发现突发传输的终止：

*   若下一个 HTRANS 标记为 BUSY 或 SEQ：突发传输未终止
*   若下一个 HTRANS 标记为 NONSEQ 或 IDLE：上一次突发传输已经终止

若突发传输是提前终止的，如总线控制权被剥夺，那么主机需要在可以进行传输时重建突发传输。例如一个 4 拍传输仅发送了一拍就终止，主机需要使用 INCR 类型的突发构建 3 拍传输以重建。

4）传输的例子

例子如下图所示：

![[../../_resources/一文搞懂 AMBA 总线工作原理/cf792d19d6a0ba1f7a4149bd9f93b82e_MD5.jpg]]

*   T0~T1：由非连续序列性的传输启动的 4 拍读。
*   T1~T2：主模块端不能进行传输，在第二个周期，所以插入了一个 BUSY 传输来延时第二次传输。此周期从模块端返回第一个周期主模块端发送读地址的读数据。
*   T2~T3：主模块端准备好进行第二次传输，发送一个 SEQ 传输。主模块端此周期将会忽略读数据总线上由任何从模块端返回的读数据（因前一个周期为 BUSY 传输）。
*   T3~T4：主模块端进行了第三次传输。发送了一个 SEQ 传输，此时读数据返回主模块端发起的第二次 SEQ 读读数据。
*   T4~T5：主模块端进行最后一次传输。此时在第一个周期内 HREADY 信号为低，从模块不能将前一次 SEQ 读的数据返回，所以将延迟上一次 SEQ 传输的 DATA Phase，也就是当前传输的 ADDRESS phase。
*   T5~T6：从模块端返回第 T3、T4 周期发送的 SEQ 读数据。
*   T6~T7：无传输命令，返回 T4、T6 发送的读数据。

### 2.5 AXI 总线

2.5.1 AXI 总线简介

AXI 作为 AMBA 总线协议的一部分，第一次出现在 AMBA 3.0 中。后面 AMBA 4.0 发布，AXI4 出现了。AXI4 总线和别的总线一样，都用来传输 bits 信息（包含了数据或者地址）。AXI 是一种面向高性能、高带宽、低延迟的片内总线。它的地址 / 控制和数据相位是分离的，支持不对齐的数据传输，同时在突发传输中，只需要首地址，同时分离的读写数据通道、并支持显著传输访问和乱序访问，并更加容易就行时序收敛。

**AXI 特点是单向通道体系结构，信息流只以单方向传输，简化时钟域间的桥接，减少门数量。**当信号经过复杂的片上系统时，减少延时。支持多项数据交换。通过并行执行猝发操作，极大地提高了数据吞吐能力，可在更短的时间内完成任务，在满足高性能要求的同时，又减少了功耗。独立的地址和数据通道。地址和数据通道分开，能对每一个通道进行单独优化，可以根据需要控制时序通道，将时钟频率提到最高，并将延时降到最低。

AXI4 总线有三种类型，分别是 AXI4、AXI4-Lite、AXI4-Stream。 AXI4 是一种高性能 memory-mapped 总线，AXI4-Lite 是一只简单的、低通量的 memory-mapped 总线，而 AXI4-Stream 可以传输高速数据流。从字面意思去理解，AXI4-Lite 是 AXI4 的轻量版。这里保留了 memory-mapped 的写法，主要是为了与 AXI4-Stream 区分开。

可以这样去理解 memory-mapped，假设有 master A， 和 slave B，A 与 B 通过 AXI4 或者 AXI4-Lite 连接通讯，A 可以把 B 这个外设看作 A 上的某个地址。当 A 向 B 传输数据时，就等同于 A 向这个地址传输数据。AXI4-Stream 与 AXI4、AXI4-Lite 不同， 它不需要地址通道。

2.5.2 AXI 总线读写框架

1）AXI 读写传输

AXI4 和 AXI4-Lite 接口包含 5 个不同的通道：两个读通道和三个写通道。每一个 AXI 传输通道都是单方向的。每一个传输都有地址和控制信息在地址通道（address channel）中，用来描述被传输数据的性质。

*   两个读通道：读地址通道 (read address channel)、读数据通道 (read data channel)。
*   三个写通道：写地址通道 (write address channel)、写数据通道 (write data channel)、写响应通道 (write response channel)。

对于读操作，主模块通过地址通道发送读传输地址，从模块通过读数据通道返回给主模块所需要的数据。

读传输的结构图如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/973c259140ee67d58e912017c66bc086_MD5.jpg]]

对于写操作，主模块通过写地址通道发送写传输地址，并通过写数据通道把数据发送给从模块。而从模块接受到数据后，需要通过写响应通道返回一个响应给主模块。

写传输的结构图如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/9d7061f7a7acb742dc234ca9ca5b966d_MD5.jpg]]

读通道和写通道是分开的，因此**可以完成数据的双向传输。此外 AXI4 能够实现 burst 传输，换句说就是，可以在一个地址后传输多个数据，最多可以达 256 字节。**AXI4-Lite 不支持 burst 传输。AXI4-Stream 只有一个通道，不需要地址，可以 burst 传输无限的数据。

这 5 条独立的通道都包含一个信息信号和一个双路的 VALD、READY 握手机制。信息源通过 VALID 信号来指示通道中的数据和控制信息什么时候有效。目地源用 READY 信号来表示何时能够接收数据。读数据和写数据通道都包括一个 LAST 信号，用来指明一个事物传输的最后一个数据。

读和写传输都有他们自己的地址通道，这地址通道携带着传输所必须的地址和信息。读数据通道传送着从模块到主模块的读数据和读响应信息。读响应信息指明读事务的完成状态。写数据通路传送着主模块向从模块的写数据。每八个数据都会有一个 byte lane ，用来指明数据总线上面的哪些 byte 有效。写响应通道提供了设备响应写传输的一种方式。这完成信号每一次突发式读写会产生一个。

2）AXI 典型连接图

![[../../_resources/一文搞懂 AMBA 总线工作原理/62386771c9b3ccbf2aeb4d9837bd1333_MD5.jpg]]

上图是一个典型的一系列主设备与一系列从设备的连接系统。这些主设备与从设备通过 interconnect 连接在一起。

AXI 协议提供单一的接口定义，主要包括：

*   manager 和 interconnect 之间。
*   subordinate 和 interconnect 之间。
*   manager 和 subordinate 之间。

AXI 协议还提出了一个重要的概念，那就是 Register Slices，因为 上述五个通道之间没有固定的关系，而且通道中传输的信息是单方向的，那么可以可以在任意一个通道中任意节点 插入 register slices，通过插入 register slice 来抵消长路径的延时，从而提高系统的性能。register slice 的使用需要平衡 时钟延时和最大工作频率之间的关系。

2.5.2 AXI 信号

![[../../_resources/一文搞懂 AMBA 总线工作原理/b2de210d3fca9226e09f5c5ef50edc81_MD5.jpg]]

2.5.3 握手信号

在了解 AXI 每个通道的定义信号后，下面对读写机制中的握手机制进行说明。

五个独立的通道均使用 VALID/READY 进行握手，VALID 由源端产生，用于指示源端发出的地址、数据、控制信息什么时候生效，READY 则由目的端产生，用于指示源端发送信息什么时候被接收，只有当 VALID 和 READY 同时为高时，才会表示本次传输完成。

VALID 和 READY 握手可以分为下面三种情况：

*   VALID 早于 READY 生效。
*   READY 早于 VALID 生效。
*   VALID 和 READY 同时生效。

具体的时序图参见下面：

![[../../_resources/一文搞懂 AMBA 总线工作原理/69ed0a4935f5b05ec8fb147cef47f6d1_MD5.jpg]]![[../../_resources/一文搞懂 AMBA 总线工作原理/e2c0444adb60c5ac2cfbf204ed18cb22_MD5.jpg]]![[../../_resources/一文搞懂 AMBA 总线工作原理/395188a89f68897efa98812fc89b936e_MD5.jpg]]

对于五个通道之间的关系，AXI 协议仅定义了下面的关系：

*   写响应必须跟随写操作的最后一个传输。
*   读数据必须紧跟读地址数据。

除了上述两点定义，AXI 未定义其他任何通道间的关系，那么对于通道间的握手信号先后顺序，必须按照特定的顺序操作，不然很容易引起接口上的 dead-lock。

具体的，读操作时，对应的读地址通道和读数据通道间握手信号的先后顺序如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/55f364e9a9cc6d40b52169d84bff404d_MD5.jpg]]

解释如下：

*   ARVALID 和 ARREADY 可以参考握手机制中的时序图所示关系；
*   RVALID 和 RREADY 可以参考握手机制中的时序图所示关系；
*   RVALID 必须在 ARVALID 和 ARREADY 同时生效后被使能；

写操作时，对应的写地址通道、写数据通道、写响应通道间的握手信号的先后顺序如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/94b650a6510b899d18e76815b8cb175e_MD5.jpg]]

解释如下：

*   AWVALID 和 AWREADY 之间的关系可以参考握手机制中的时序图。
*   WVALID 和 WREADY 之间的关系可以参考握手机制中的时序图。
*   WVALID 和 AWREADY 之间也可以参考握手机制中的时序图。
*   BAVALID 和 BREADY 之间的关系可以参考握手机制中的时序图。
*   BVALID 必须在 WVALID 和 WREADY 同时生效之后再被使能，同时必须是 WLAST 之后。

上述写操作通道间握手顺序是基于 AXI3 协议，AXI4/5 在 AXI3 基础上有改进，具体如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/6cab803985cd344c65565b3240e2506a_MD5.jpg]]

AXI4/5 协议对于 BVALID 置位条件加强了，同时需要满足 WVALID/WREADY 和 AWVALID/AWREADY 生效之后，且是在 WLAST 之后，才能被使能；

2.5.4 地址结构

AXI 协议传输数据时控制信息采用 Start_address+Length 形式，即 Manager 发出 start_address、length 以及 burst 类型、每次传输的大小等，subordinate 需要根据这些信息计算后续的地址，决定返回那些地址对应的数据给 manager；那么如何根据 manager 发送的 address、length、burst 类型、每个传输的大小这些信息计算出 manager 需要访问的地址，需要先看一下 AXI 协议所定义的地址结构；

2.5.5 burst length

AXI 协议定义 ARLEN、AWLEN 分别表示读操作长度和写操作长度，后面统一使用 AxLEN 统一表示。

AxLEN 的含义：AxLEN+1 个传输 (transfer)。

如 AxLEN=7，AxSIZE=16byte(后面会讲到)，那么本次 burst 传输的数据量为：8*16=128byte。

AXI3 协议定义 AxLEN 范围：1~16；对应的 AxLEN 使用 4bit 表示。

AXI4 协议定义 AxLEN 范围：1~256，对应的 AxLEN 使用 8bit 表示。

对于 Length 还有如下几点限制条件：

*   对于 WARP 类型的 burst，burst length 必须为 2、4、8 或者 16。
*   burst 不能超过 4KB 地址边界。
*   burst 不支持提前结束。

2.5.6 burst size

burst size 表示每次传输 (transfer) 包含多少 byte，分别定义了 ARSIZE、AWSIZE 分别表示读传输、写传输大小。

后面统一使用 AxSIZE 表示，AxSIZE 使用 3bit 表示，具体的译码方式参见下图：

![[../../_resources/一文搞懂 AMBA 总线工作原理/e629afd2836c66deeff022507d15df50_MD5.jpg]]

AxSIZE 指定的传输大小不能超过系统工作的数据位宽。

2.5.7 burst type

AXI 协议规定下面三种 burst 类型：

![[../../_resources/一文搞懂 AMBA 总线工作原理/597e928c917dd5c7b70f4e1abf098e9e_MD5.jpg]]

同理，AxBURST 为 ARBURST 和 AWBURST 的统称，分别表示读操作、写操作 burst 类型。

*   FIXED 表示每次传输的地址是相同的地址，常用于对 FIFO 的访问。
*   INCR 表示每次地址都是按照递增类型，下次传输的地址 = 当前传输地址 + 当前传输的大小。
*   WRAP 表示每次地址都是按照递增类型，只有在达到地址边界的时候，会卷绕到低位的地址边界开始，这种卷绕方式同 AHB 协议相同。

2.5.8 响应类型

上面分析地址结构、数据结构，接下来介绍一下响应类型，BRESP、RRESP 分别表示写响应、读响应，后面统一使用 xRESP 表示，具体的译码规则如下：

![[../../_resources/一文搞懂 AMBA 总线工作原理/18d45363a8ba1a8dd153dc732d6dd47e_MD5.jpg]]

### 2.6 AXI、AHB、APB 总线对比

AHB：针对高效率、高频宽及快速系统模块所设计的总线，它可以连接如 CPU、芯片上或芯片外的内存模块和 DMA 等高效率模块。

APB：用在低速且低功耗的外围设备，针对外围设备作功率消耗及复杂接口的优化。APB 在 AHB 和低带宽的外围设备之间提供了通信的桥梁，所以 APB 是 AHB 的二级拓展总线。

AXI：高速度、高带宽、管道化互联、单向通道，只需要首地址、读写并行、支持乱序、支持非对齐操作，但连线非常多。

AXI、AHB、APB 总线的性能对比分析：

![[../../_resources/一文搞懂 AMBA 总线工作原理/0202750d10b0a96486eedf32e67a3a50_MD5.jpg]]

AHB 是高级高性能总线，AXI 是高级可扩展接口，APB 是高级外围总线。AHB 和 APB 都是单通道总线，不支持读写并行。而 AXI 是多通道总线，总共分为五个通道，能够实现读写并行。AHB 和 AXI 都是多主 / 从设备，且通过仲裁机制实现总线控制权的分配。而 APB 是单主设备多从设备，其主设备就是 APB 桥，不具有仲裁机制。在数据操作方面，AHB 和 AXI 支持突发传输，APB 不支持。此外，AXI 支持数据的非对齐操作，AHB 不支持。

（平时会分享 linux 技术干货文章。关注我，可以定期收到相关文章的推送。知乎、微信同名：黑客与摄影师）

参考资料

[【计算机基础】总线定义与分类_高阳. 的博客 - CSDN 博客](https://link.zhihu.com/?target=https%3A//blog.csdn.net/qq_41324483/article/details/90736576)

[https://mp.weixin.qq.com/s/B8fv_LH01n7jOkVkeHobcw](https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/B8fv_LH01n7jOkVkeHobcw)

[https://www.jianshu.com/p/65281e71753f](https://link.zhihu.com/?target=https%3A//www.jianshu.com/p/65281e71753f)

[https://zhuanlan.zhihu.com/p/161077476](https://zhuanlan.zhihu.com/p/161077476)

[https://developer.arm.com/architectures/system-architectures/amba](https://link.zhihu.com/?target=https%3A//developer.arm.com/architectures/system-architectures/amba)

[https://www.jianshu.com/p/b2df0788bbd9](https://link.zhihu.com/?target=https%3A//www.jianshu.com/p/b2df0788bbd9)

[https://mp.weixin.qq.com/s/i3Osc_-eY8nFf-NhrSyBPA](https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/i3Osc_-eY8nFf-NhrSyBPA)

[https://www.arm.com/architecture/system-architectures/amba](https://link.zhihu.com/?target=https%3A//www.arm.com/architecture/system-architectures/amba)

[AMBA 总线—AHB 总线协议详解_little_ox 的博客 - CSDN 博客_ahb 总线协议](https://link.zhihu.com/?target=https%3A//blog.csdn.net/little_ox/article/details/118399117%3Fspm%3D1001.2101.3001.6650.1%26utm_medium%3Ddistribute.pc_relevant.none-task-blog-2%257Edefault%257ECTRLIST%257ERate-1-118399117-blog-102673398.pc_relevant_3mothn_strategy_recovery%26depth_1-utm_source%3Ddistribute.pc_relevant.none-task-blog-2%257Edefault%257ECTRLIST%257ERate-1-118399117-blog-102673398.pc_relevant_3mothn_strategy_recovery%26utm_relevant_index%3D2)

[https://mp.weixin.qq.com/s/PObYpd-yBYPR5kZbxbXDcQ](https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/PObYpd-yBYPR5kZbxbXDcQ)